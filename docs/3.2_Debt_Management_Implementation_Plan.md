# 3.2 GestÃ£o de DÃ­vidas - Implementation Plan
## AgroCommand - 50,000 Hectares Soybean Farm

### Executive Summary
Implementation plan for the Debt Management page (3.2) of AgroCommand platform, designed for comprehensive debt portfolio management of R$ 287.5M across multiple currencies, institutions, and financial instruments for a large-scale agricultural operation.

---

## ðŸ’° Realistic Debt Portfolio Data (50,000 hectares operation)

### Portfolio Overview
- **Total Debt**: R$ 287,500,000
- **USD Exposure**: 42% (US$ 24.2M at 5.42 exchange rate = R$ 131.2M)
- **BRL Exposure**: 58% (R$ 166.8M)
- **Weighted Average Rate**: 9.7% p.a.
- **Average Maturity**: 21 months
- **DSCR**: 1.48x (above 1.25x minimum)

### Debt Composition by Currency
```typescript
const debtByCurrency = {
  BRL: {
    amount: 166800000,
    percentage: 58,
    avgRate: 10.2,
    avgMaturity: 18
  },
  USD: {
    amount: 120700000, // R$ equivalent
    usdAmount: 24200000,
    percentage: 42,
    avgRate: 8.8,
    avgMaturity: 24
  }
}
```

### Debt by Interest Rate Type
```typescript
const debtByRateType = {
  CDI: { amount: 100625000, percentage: 35, currentRate: 13.25, spread: 2.5 },
  PreFixed: { amount: 80500000, percentage: 28, avgRate: 11.8 },
  TJLP: { amount: 43125000, percentage: 15, currentRate: 7.97, spread: 4.2 },
  Libor: { amount: 34500000, percentage: 12, currentRate: 5.33, spread: 3.8 },
  IPCA: { amount: 28750000, percentage: 10, expectedInflation: 3.8, spread: 4.5 }
}
```

### Major Contracts
```typescript
const majorContracts = [
  {
    institution: "Banco do Brasil",
    originalAmount: 85000000,
    currentBalance: 72300000,
    currency: "BRL",
    rateType: "CDI+2.5%",
    maturity: "2026-03-15",
    dscr: 1.52,
    purpose: "Working Capital"
  },
  {
    institution: "Rabobank",
    originalAmount: 15000000, // USD
    currentBalance: 12800000, // USD
    currency: "USD",
    rateType: "Libor+3.8%",
    maturity: "2025-08-22",
    dscr: 1.38,
    purpose: "Equipment Financing"
  },
  {
    institution: "John Deere Financial",
    originalAmount: 45500000,
    currentBalance: 38900000,
    currency: "BRL",
    rateType: "11.8% p.a.",
    maturity: "2027-12-10",
    dscr: 1.67,
    purpose: "Machinery"
  }
]
```

---

## ðŸŽ¯ Implementation Task Breakdown

### Phase 1: Core Infrastructure & Data Models
**Timeline**: 2-3 weeks

#### Task 1.1: Data Models & Types
**Estimated Time**: 4 days
- [ ] Create TypeScript interfaces for debt portfolio data
- [ ] Define API contracts for debt management
- [ ] Set up mock data with realistic debt scenarios
- [ ] Create utility functions for debt calculations (DSCR, ratios, etc.)
- [ ] Implement currency conversion utilities

**Files to Create**:
```
types/debt-management.ts
services/debt-api.ts
utils/debt-calculations.ts
utils/currency-converter.ts
data/mock-debt-data.ts
```

#### Task 1.2: API Integration Layer
**Estimated Time**: 3 days
- [ ] Implement TanStack Query for debt data fetching
- [ ] Create custom hooks for debt portfolio management
- [ ] Set up real-time updates for covenant monitoring
- [ ] Add error handling for critical debt operations
- [ ] Implement caching strategies for debt data

**Files to Create**:
```
hooks/use-debt-portfolio.ts
hooks/use-covenant-monitoring.ts
hooks/use-currency-risk.ts
services/debt-queries.ts
```

### Phase 2: UI Components Foundation
**Timeline**: 3 weeks

#### Task 2.1: Header & KPI Cards
**Estimated Time**: 3 days
- [ ] Enhanced header with debt overview metrics
- [ ] Total debt, USD exposure, average rate display
- [ ] DSCR indicator with visual gauge
- [ ] Next payment alert system
- [ ] Real-time status indicators

**Components to Build**:
```
components/debt/debt-header.tsx
components/debt/debt-overview-cards.tsx
components/debt/dscr-indicator.tsx
components/debt/payment-alert.tsx
```

#### Task 2.2: Portfolio Composition Charts
**Estimated Time**: 5 days
- [ ] Interactive donut chart with multiple views
- [ ] Currency breakdown visualization
- [ ] Interest rate type distribution
- [ ] Institution exposure analysis
- [ ] Purpose/collateral breakdown
- [ ] Dynamic center content based on selection

**Components to Build**:
```
components/debt/portfolio-donut.tsx
components/debt/portfolio-legend.tsx
components/debt/portfolio-controls.tsx
components/charts/interactive-donut.tsx
```

#### Task 2.3: Maturity Profile Chart
**Estimated Time**: 4 days
- [ ] Stacked area chart for payment schedule
- [ ] 10-year maturity timeline
- [ ] Principal vs interest breakdown
- [ ] Payment capacity overlay line
- [ ] Seasonal cash flow integration
- [ ] Stress scenario visualization

**Components to Build**:
```
components/debt/maturity-profile.tsx
components/debt/payment-capacity-line.tsx
components/charts/stacked-area-chart.tsx
```

### Phase 3: Advanced Data Tables & Analysis
**Timeline**: 2 weeks

#### Task 3.1: Contracts Management Table
**Estimated Time**: 5 days
- [ ] Advanced DataGrid with sorting/filtering
- [ ] Expandable rows for contract details
- [ ] Inline editing capabilities
- [ ] Bulk operations (payments, renegotiation)
- [ ] Status indicators and alerts
- [ ] Export functionality

**Components to Build**:
```
components/debt/contracts-table.tsx
components/debt/contract-details-row.tsx
components/debt/contract-actions.tsx
components/ui/advanced-data-grid.tsx
```

#### Task 3.2: Sensitivity Analysis Heatmap
**Estimated Time**: 4 days
- [ ] Interactive heatmap matrix
- [ ] Selic vs USD/BRL impact analysis
- [ ] Color-coded risk levels
- [ ] Scenario probability indicators
- [ ] Drill-down capabilities
- [ ] Export to scenario planning

**Components to Build**:
```
components/debt/sensitivity-heatmap.tsx
components/debt/scenario-tooltip.tsx
components/charts/risk-heatmap.tsx
```

### Phase 4: Covenant Monitoring & Risk Management
**Timeline**: 2 weeks

#### Task 4.1: Covenant Dashboard
**Estimated Time**: 4 days
- [ ] DSCR monitoring with gauge visualization
- [ ] Debt/EBITDA ratio tracking
- [ ] Liquidity ratio indicators
- [ ] Collateral utilization display
- [ ] Automated alert system
- [ ] Historical trend analysis

**Components to Build**:
```
components/debt/covenant-dashboard.tsx
components/debt/covenant-gauge.tsx
components/debt/covenant-alerts.tsx
components/debt/covenant-history.tsx
```

#### Task 4.2: Currency Risk Management
**Estimated Time**: 5 days
- [ ] USD exposure tracking chart
- [ ] Hedge ratio visualization
- [ ] VaR (Value at Risk) calculations
- [ ] Hedge operations history
- [ ] Automatic hedging recommendations
- [ ] Market opportunity alerts

**Components to Build**:
```
components/debt/currency-risk-chart.tsx
components/debt/hedge-operations.tsx
components/debt/var-calculator.tsx
components/debt/hedge-recommendations.tsx
```

### Phase 5: Scenario Planning & Optimization
**Timeline**: 2 weeks

#### Task 5.1: Debt Restructuring Simulator
**Estimated Time**: 6 days
- [ ] Interactive controls for scenario testing
- [ ] Real-time impact calculations
- [ ] ROI analysis for restructuring options
- [ ] Cash flow impact projections
- [ ] Risk assessment framework
- [ ] Recommendation engine

**Components to Build**:
```
components/debt/restructuring-simulator.tsx
components/debt/scenario-controls.tsx
components/debt/impact-calculator.tsx
components/debt/recommendations-panel.tsx
```

#### Task 5.2: Stress Testing & Contingency
**Estimated Time**: 3 days
- [ ] Predefined stress scenarios
- [ ] Custom scenario builder
- [ ] Survival analysis (months of liquidity)
- [ ] Emergency funding sources
- [ ] Contingency plan generator

**Components to Build**:
```
components/debt/stress-testing.tsx
components/debt/contingency-panel.tsx
components/debt/survival-analysis.tsx
```

### Phase 6: Advanced Features & Integrations
**Timeline**: 1.5 weeks

#### Task 6.1: Reporting & Export System
**Estimated Time**: 4 days
- [ ] PDF debt position reports
- [ ] Excel export with formulas
- [ ] Automated covenant reporting
- [ ] Regulatory compliance reports
- [ ] Email scheduling system

#### Task 6.2: Alert & Notification System
**Estimated Time**: 3 days
- [ ] Payment reminders (30/15/7 days)
- [ ] Covenant breach warnings
- [ ] Market opportunity alerts
- [ ] Rate change notifications
- [ ] Multi-channel delivery (email, SMS, dashboard)

---

## ðŸ”§ Technical Implementation Details

### Component Architecture
```
app/(dashboard)/financial/debt-management/
â”œâ”€â”€ page.tsx                          # Main debt management page
â”œâ”€â”€ loading.tsx                       # Loading skeleton
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ debt-header.tsx              # Header with overview metrics
â”‚   â”œâ”€â”€ portfolio-composition.tsx    # Donut chart section
â”‚   â”œâ”€â”€ maturity-profile.tsx         # Payment timeline chart
â”‚   â”œâ”€â”€ contracts-table.tsx          # Detailed contracts grid
â”‚   â”œâ”€â”€ sensitivity-analysis.tsx     # Risk heatmap
â”‚   â”œâ”€â”€ covenant-monitoring.tsx      # Compliance dashboard
â”‚   â”œâ”€â”€ currency-risk.tsx            # FX risk management
â”‚   â”œâ”€â”€ debt-simulator.tsx           # Restructuring tools
â”‚   â””â”€â”€ filters-sidebar.tsx          # Advanced filters
```

### Data Flow Architecture
```typescript
interface DebtPortfolio {
  overview: DebtOverview
  composition: DebtComposition
  maturityProfile: MaturityProfile[]
  contracts: DebtContract[]
  covenants: CovenantStatus
  currencyRisk: CurrencyRiskData
  scenarios: ScenarioAnalysis
}

interface DebtOverview {
  totalDebt: number
  usdExposure: number
  avgRate: number
  dscr: number
  nextPayment: PaymentInfo
  lastUpdated: Date
}
```

### Key Performance Metrics
```typescript
const debtKPIs = {
  totalDebt: 287500000,
  usdExposurePercent: 42,
  avgWeightedRate: 9.7,
  dscr: 1.48,
  debtToEbitda: 2.02,
  nextPaymentAmount: 12500000,
  nextPaymentDays: 15,
  covenantStatus: 'compliant'
}
```

### Risk Management Calculations
```typescript
// DSCR Calculation
const calculateDSCR = (ebitda: number, debtService: number) => {
  return ebitda / debtService
}

// Currency VaR Calculation  
const calculateCurrencyVaR = (usdExposure: number, volatility: number, confidence: number) => {
  const zScore = confidence === 95 ? 1.645 : 2.326
  return usdExposure * volatility * zScore
}

// Debt Service Coverage
const calculateDebtService = (principal: number, interest: number) => {
  return principal + interest
}
```

### Integration Points
- [ ] Banking APIs for real-time balance updates
- [ ] Currency APIs for live exchange rates
- [ ] Interest rate feeds for covenant monitoring
- [ ] Credit rating services integration
- [ ] Document management system

---

## ðŸ“Š Data Visualization Specifications

### 1. Portfolio Composition Donut Chart
- **Size**: 40% width, 450px height
- **Data**: 4 different views (Currency/Rate Type/Institution/Purpose)
- **Interactivity**: Hover expansion, click drill-down
- **Center Display**: Dynamic metrics based on selection
- **Colors**: Professional financial palette

### 2. Maturity Profile Stacked Area
- **Period**: 10 years (40 quarters)
- **Layers**: BRL Principal, USD Principal, Interest
- **Reference Lines**: Payment capacity, EBITDA projection
- **Interactions**: Zoom, scenario overlay, stress testing

### 3. Sensitivity Heatmap
- **Matrix**: 7x11 (Selic vs USD/BRL scenarios)
- **Values**: Impact on debt service (%)
- **Color Coding**: Green (benefit), Yellow (neutral), Red (risk)
- **Features**: Probability overlays, current position marker

### 4. Covenant Monitoring Gauges
- **DSCR**: Semicircular gauge with compliance zones
- **Debt/EBITDA**: Linear progress with warning thresholds
- **Liquidity**: Multi-metric dashboard
- **Visual Alerts**: Color-coded status indicators

---

## ðŸš€ Development Guidelines

### Code Standards
- Follow existing project patterns from financial overview
- Use TypeScript for all debt calculations
- Implement comprehensive error handling
- Add loading states for all debt operations
- Follow shadcn/ui component library

### Data Accuracy
- Based on realistic Brazilian agricultural debt structures
- Industry-standard covenant ratios
- Current market interest rates (Selic 13.25%, TJLP 7.97%)
- Realistic DSCR targets (1.25x minimum, 1.48x current)

### Performance Targets
- Page load: <3 seconds for full debt portfolio
- Chart interactions: <200ms response time
- Real-time updates: <1 second for covenant changes
- Export generation: <5 seconds for comprehensive reports

### Security Considerations
- Encrypt sensitive debt information
- Role-based access for debt operations
- Audit trail for all debt modifications
- Secure API endpoints for banking integrations

---

## ðŸ“‹ Deliverables Checklist

### MVP (Minimum Viable Product)
- [ ] Debt portfolio overview with key metrics
- [ ] Interactive composition donut chart
- [ ] Payment schedule visualization
- [ ] Contracts management table
- [ ] Basic covenant monitoring
- [ ] Export to PDF/Excel

### Advanced Features
- [ ] Full sensitivity analysis
- [ ] Currency risk management
- [ ] Debt restructuring simulator
- [ ] Automated alert system
- [ ] Stress testing capabilities
- [ ] Regulatory reporting

### Testing & Quality
- [ ] Unit tests for debt calculations
- [ ] Integration tests for banking APIs
- [ ] Performance testing with large portfolios
- [ ] Security testing for sensitive data
- [ ] Accessibility compliance
- [ ] Cross-browser compatibility

---

## ðŸ“ˆ Success Metrics

### Financial Accuracy
- [ ] Precise DSCR calculations
- [ ] Accurate covenant compliance monitoring
- [ ] Real-time currency conversion
- [ ] Correct interest accrual calculations

### User Experience
- [ ] Intuitive debt portfolio navigation
- [ ] Clear risk visualization
- [ ] Effective alert system
- [ ] Smooth chart interactions
- [ ] Professional reporting output

### Technical Performance
- [ ] Sub-3 second load times
- [ ] Real-time data synchronization
- [ ] Reliable alert delivery
- [ ] Secure data handling
- [ ] Scalable architecture

This implementation plan provides a comprehensive roadmap for building a sophisticated debt management system that matches the complexity and requirements of a R$ 287.5M agricultural debt portfolio while maintaining the high standards established by the financial overview page.